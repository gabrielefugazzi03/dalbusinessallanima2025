<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Elenco Questionari - Accesso Riservato</title>
  <!-- Includi il Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <!-- Importa il font Poppins -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;700&display=swap" rel="stylesheet" />
  <style>
    /* RESET E BASE */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
      background-size: 400% 400%;
      animation: gradientBG 15s ease infinite;
      color: #333;
      padding: 10px;
    }
    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    /* Contenitore principale (visibile dopo il login) */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: rgba(255,255,255,0.9);
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 { text-align: center; margin-bottom: 20px; font-size: 2em; }
    /* Sezione di Login */
    #login-container {
      max-width: 400px;
      margin: 100px auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    #login-container h2 { text-align: center; margin-bottom: 20px; }
    #login-form { display: flex; flex-direction: column; }
    #login-form input {
      margin-bottom: 10px; padding: 10px; font-size: 1em;
      border: 1px solid #ccc; border-radius: 4px;
    }
    #login-form button {
      padding: 10px; font-size: 1em;
      background: #3498db; color: white; border: none;
      border-radius: 4px; cursor: pointer;
    }
    /* Header della tabella e logout */
    .table-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 10px;
    }
    #dataIndicator {
      background: rgba(0, 0, 0, 0.05); padding: 12px 16px;
      border-radius: 5px; font-size: 0.9em;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    #logoutBtn {
      background: #ff4757;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 10px;
      cursor: pointer;
    }
    /* Pulsanti della tabella */
    #newQuestionarioBtn, #downloadJsonBtn {
      padding: 12px 24px; border: none; border-radius: 30px;
      background: #ff6b6b; color: #fff; font-weight: 500;
      text-transform: uppercase; letter-spacing: 1px;
      cursor: pointer; transition: background 0.3s ease, transform 0.2s ease;
      margin-right: 10px;
    }
    #newQuestionarioBtn:hover, #downloadJsonBtn:hover {
      background: #ff4757; transform: translateY(-2px);
    }
    /* Tabella */
    table.compact-table {
      border-collapse: collapse; width: 100%;
      margin: 0; font-size: 0.9rem;
    }
    table.compact-table th, table.compact-table td {
      border: 1px solid #ccc; padding: 6px 10px;
      text-align: center; vertical-align: middle;
    }
    table.compact-table th {
      background-color: #f0f0f0; font-weight: 600;
      cursor: pointer; transition: background-color 0.3s ease;
    }
    table.compact-table th:hover { background-color: #e0e0e0; }
    table.compact-table tbody tr:nth-child(even) { background: #fafafa; }
    table.compact-table tbody tr:hover { background: #f1f1f1; }
    /* Filtro delle colonne */
    .filter-row input {
      width: 90%; padding: 4px; border: 1px solid #ddd;
      border-radius: 4px; font-size: 0.8rem;
    }
    .filter-row input:focus { border-color: #0984e3; outline: none; }
    /* Pulsanti icona */
    .icon-button {
      background: none; border: none; cursor: pointer;
      font-size: 1.4em; margin: 0 5px; color: #ff6b6b;
      transition: color 0.3s ease, transform 0.2s ease;
    }
    .icon-button:hover { color: #ff4757; transform: scale(1.1); }
    .status-icon {
      display: inline-block; width: 24px; height: 24px;
      line-height: 24px; text-align: center; border-radius: 50%;
      font-weight: bold; color: white; cursor: default;
    }
    /* Modal per commenti */
    #commentiModal {
      display: none; position: fixed;
      top: 50%; left: 50%; transform: translate(-50%, -50%);
      z-index: 9999; background: #fff; padding: 20px;
      border: 2px solid #333; border-radius: 8px;
      max-width: 400px; box-shadow: 0 2px 8px rgba(0,0,0,0.5);
    }
    #commentiModal h2 { margin-bottom: 10px; }
    #commentiModalText { white-space: pre-wrap; margin-bottom: 15px; }
    #closeModalBtn {
      padding: 8px 16px; border: none; border-radius: 4px;
      background: #3498db; color: #fff; cursor: pointer; font-weight: 500;
      transition: background 0.3s ease;
    }
    #closeModalBtn:hover { background: #2980b9; }
    /* Nascondi inizialmente il contenuto protetto */
    #content { display: none; }
  </style>
</head>
<body>
  <!-- Sezione Login -->
  <div id="login-container">
    <h2>Accesso Riservato</h2>
    <form id="login-form">
      <input type="email" id="email" placeholder="Email" required>
      <input type="password" id="password" placeholder="Password" required>
      <button type="submit">Accedi</button>
    </form>
    <div id="login-error" style="color:red;"></div>
  </div>

  <!-- Sezione Contenuto Protetto (visibile solo dopo il login) -->
  <div id="content">
    <div class="container">
      <div class="table-header">
        <div>
          <button id="newQuestionarioBtn">Nuovo questionario</button>
          <button id="downloadJsonBtn" onclick="downloadJSON()">SCARICA</button>
        </div>
        <div id="dataIndicator">Caricamento...</div>
        <!-- Pulsante di Logout -->
        <button id="logoutBtn">Logout</button>
      </div>
      <h1>Elenco Questionari</h1>
      <!-- Tabella dei questionari -->
      <table id="questionariTable" class="compact-table">
        <thead>
          <tr>
            <th>Status</th>
            <th data-key="questionario_id">ID Questionario</th>
            <th data-key="informazioni_compilazione.vicariato">Vicariato</th>
            <th data-key="informazioni_compilazione.comunità_pastorale">Comunità Pastorale</th>
            <th data-key="informazioni_compilazione.parrocchie">Parrocchie</th>
            <th data-key="studente_compilatore">Studente Compilatore</th>
            <th data-key="datatime_ultima_modifica">Data Ultima Modifica</th>
            <th>Completamento</th>
            <th>Azioni</th>
          </tr>
          <tr class="filter-row">
            <th><input type="text" class="column-filter" data-col-index="0" placeholder="Filtra..." /></th>
            <th><input type="text" class="column-filter" data-col-index="1" placeholder="Filtra..." /></th>
            <th><input type="text" class="column-filter" data-col-index="2" placeholder="Filtra..." /></th>
            <th><input type="text" class="column-filter" data-col-index="3" placeholder="Filtra..." /></th>
            <th><input type="text" class="column-filter" data-col-index="4" placeholder="Filtra..." /></th>
            <th><input type="text" class="column-filter" data-col-index="5" placeholder="Filtra..." /></th>
            <th><input type="text" class="column-filter" data-col-index="6" placeholder="Filtra..." /></th>
            <th></th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <!-- Le righe verranno generate dinamicamente dalla funzione buildTable() -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Modal per commenti del revisore -->
  <div id="commentiModal">
    <h2>Commenti Revisore</h2>
    <div id="commentiModalText"></div>
    <button id="closeModalBtn" onclick="closeCommentiModal()">Chiudi</button>
  </div>

  <script>
    /****************************************************
     * CONFIGURAZIONE SUPABASE
     ****************************************************/
    // NOTA: Utilizziamo la chiave anonima (pubblica) di Supabase. Le operazioni sensibili devono essere gestite lato server.
    const supabaseUrl = 'https://arvsrkvnsnwxhjwklmws.supabase.co';
    const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFydnNya3Zuc253eGhqd2tsbXdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI2NTc1MjgsImV4cCI6MjA1ODIzMzUyOH0.VtsXnQcWKZIdhl1YQ-uLrur5f0Xink66XxKFvIsYLCk';
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseAnonKey);

    /****************************************************
     * GESTIONE DEL LOGIN E LOGOUT CON SUPABASE AUTH
     ****************************************************/
    document.addEventListener('DOMContentLoaded', () => {
      // Controlla se esiste una sessione utente
      checkSession();

      // Gestione del form di login
      const loginForm = document.getElementById('login-form');
      loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;

        // Effettua il login usando signInWithPassword (v2)
        const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
        if (error) {
          console.error("Errore nel login:", error);
          document.getElementById('login-error').innerText = error.message;
        } else {
          // Login riuscito: mostra il contenuto protetto
          document.getElementById('login-container').style.display = 'none';
          document.getElementById('content').style.display = 'block';
          buildTable();
        }
      });

      // Gestione del pulsante di logout
      document.getElementById('logoutBtn').addEventListener('click', async () => {
        const { error } = await supabaseClient.auth.signOut();
        if (error) {
          console.error("Errore durante il logout:", error);
        } else {
          // Logout riuscito: torna al form di login
          document.getElementById('content').style.display = 'none';
          document.getElementById('login-container').style.display = 'block';
        }
      });
    });

    async function checkSession() {
      const { data: { session }, error } = await supabaseClient.auth.getSession();
      if (error) {
        console.error("Errore nel getSession:", error);
        return;
      }
      if (session) {
        document.getElementById('login-container').style.display = 'none';
        document.getElementById('content').style.display = 'block';
        buildTable();
      } else {
        document.getElementById('login-container').style.display = 'block';
        document.getElementById('content').style.display = 'none';
      }
    }

    /****************************************************
     * FUNZIONI UTILITY E DI SUPPORTO
     ****************************************************/
    function generateUUID() {
      return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, function(c) {
        const r = (Math.random() * 16) | 0;
        const v = c === "x" ? r : (r & 0x3) | 0x8;
        return v.toString(16);
      });
    }

    function downloadJSON() {
      const data = JSON.stringify(docsGlobal, null, 4);
      const blob = new Blob([data], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "backup_questionari.json";
      a.click();
      URL.revokeObjectURL(url);
    }

    function parseItalianDateTime(localStr) {
      const parts = localStr.split(/[\/\s:]+/);
      if (parts.length >= 5) {
        const day = parseInt(parts[0], 10);
        const month = parseInt(parts[1], 10) - 1;
        const year = parseInt(parts[2], 10);
        const hour = parseInt(parts[3], 10);
        const min = parseInt(parts[4], 10);
        return new Date(year, month, day, hour, min);
      }
      return null;
    }

    function isTableRowFilled(row) {
      const ignoreKeys = ["ID_Parrocchia", "Nome_Parrocchia", "ID_Vicariato", "ID_Comunità"];
      for (const key in row) {
        if (!ignoreKeys.includes(key)) {
          const val = row[key];
          if (typeof val === "string" && val.trim() !== "") return true;
          if (typeof val === "boolean" && val === true) return true;
          if (typeof val === "number" && val !== 0) return true;
        }
      }
      return false;
    }

    function calculateCompletionSerious(q, s) {
      let totalFields = 0;
      let filledFields = 0;
      
      function recurse(standardObj, questionObj) {
        Object.keys(standardObj).forEach(key => {
          const sVal = standardObj[key];
          if (sVal && typeof sVal === 'object' && (sVal.hasOwnProperty('value') || sVal.input_type === "table")) {
            totalFields++;
            if (sVal.input_type === "table") {
              if (questionObj && questionObj[key] && Array.isArray(questionObj[key].rows)) {
                const hasFilledRow = questionObj[key].rows.some(row => isTableRowFilled(row));
                if (hasFilledRow) filledFields++;
              }
            } else {
              const qVal = questionObj && questionObj[key] ? questionObj[key].toString().trim() : "";
              const sStdVal = sVal.value.toString().trim();
              if (sStdVal === "") {
                if (qVal !== "") filledFields++;
              } else {
                if (qVal !== "" && qVal !== sStdVal) filledFields++;
              }
            }
          } else if (sVal && typeof sVal === 'object') {
            const qChild = questionObj ? questionObj[key] : undefined;
            recurse(sVal, qChild);
          }
        });
      }
      
      recurse(s, q);
      return totalFields > 0 ? Math.round((filledFields / totalFields) * 100) : 0;
    }

    function classifyCompletion(percentage) {
      return percentage >= completionThreshold ? "Compilato" : "Non compilato";
    }

    function updateIndicator() {
      const numQuestionari = docsGlobal.length;
      const vicariatiSet = new Set();
      docsGlobal.forEach(q => {
        const vic = q?.informazioni_compilazione?.vicariato;
        if (vic) vicariatiSet.add(vic);
      });
      const numVicariati = vicariatiSet.size;
      const indicatorHTML = `
        <div>Questionari: ${numQuestionari} / ${totalQuestionari}</div>
        <div>Vicariati coperti: ${numVicariati} / ${totalVicariati}</div>
        <div>Comunità pastorali: ${numQuestionari} / ${totalComunità}</div>
      `;
      document.getElementById("dataIndicator").innerHTML = indicatorHTML;
    }

    /****************************************************
     * CARICAMENTO DEI DATI E RENDERING DELLA TABELLA
     ****************************************************/
    let docsGlobal = [];
    let currentSort = { key: null, direction: -1 };
    let strutturaData = null; // Da caricare da struttura.json
    const totalQuestionari = 30;
    const totalVicariati = 7;
    const totalComunità = 38;
    const completionThreshold = 50;

    async function buildTable() {
      try {
        const { data, error } = await supabaseClient
          .from('raw_questionari')
          .select('data');
        if (error) {
          console.error("Errore nel caricamento dei questionari:", error);
        } else {
          docsGlobal = data.map(record => record.data);
          updateIndicator();
          currentSort = { key: 'datatime_ultima_modifica', direction: -1 };
          sortAndRenderTable();
        }
      } catch (err) {
        console.error("Errore nel caricamento dei questionari:", err);
      }
    }

    function sortAndRenderTable() {
      let sortedDocs = docsGlobal.slice();
      if (currentSort.key) {
        sortedDocs.sort((a, b) => {
          const aVal = getNestedValue(a, currentSort.key);
          const bVal = getNestedValue(b, currentSort.key);
          if (aVal < bVal) return -1 * currentSort.direction;
          if (aVal > bVal) return 1 * currentSort.direction;
          return 0;
        });
      } else {
        sortedDocs.sort((a, b) => {
          const vicA = a?.informazioni_compilazione?.vicariato || "";
          const vicB = b?.informazioni_compilazione?.vicariato || "";
          return String(vicA).localeCompare(String(vicB));
        });
      }
      renderTable(sortedDocs);
      applyColumnFilters();
    }

    function getNestedValue(obj, keyPath) {
      const keys = keyPath.split('.');
      let value = obj;
      keys.forEach(key => {
        value = value ? value[key] : "";
      });
      return value || "";
    }

    function renderTable(docs) {
      const tbody = document.querySelector("#questionariTable tbody");
      tbody.innerHTML = "";
      docs.forEach(q => {
        const tr = document.createElement("tr");
        // Stato
        const tdStatus = document.createElement("td");
        const status = q?.status_record || "";
        const commentiRevisore = q?.commenti_revisore || "";
        tdStatus.innerHTML = getStatusIcon(status, commentiRevisore);
        const isLockedByOther = q?.allocated && (q.allocated !== localStorage.getItem('myLockId'));
        if (isLockedByOther) {
          const lockIcon = document.createElement("span");
          lockIcon.innerHTML = "&#128274;";
          lockIcon.title = "Record bloccato da un altro utente";
          tdStatus.appendChild(document.createTextNode(" "));
          tdStatus.appendChild(lockIcon);
        }
        tr.appendChild(tdStatus);
        // ID Questionario
        const tdId = document.createElement("td");
        tdId.textContent = q?.questionario_id || "";
        tr.appendChild(tdId);
        // Vicariato
        const tdVicariato = document.createElement("td");
        tdVicariato.textContent = q?.informazioni_compilazione?.vicariato || "";
        tr.appendChild(tdVicariato);
        // Comunità Pastorale
        const tdComunita = document.createElement("td");
        tdComunita.textContent = q?.informazioni_compilazione?.["comunità_pastorale"] || "";
        tr.appendChild(tdComunita);
        // Parrocchie
        const tdParrocchie = document.createElement("td");
        let parrocchieText = "";
        if (q?.informazioni_compilazione?.parrocchie?.rows?.length) {
          parrocchieText = q.informazioni_compilazione.parrocchie.rows
            .map(r => r.Nome_Parrocchia)
            .join(", ");
        }
        tdParrocchie.textContent = parrocchieText;
        tr.appendChild(tdParrocchie);
        // Studente Compilatore
        const tdStudente = document.createElement("td");
        tdStudente.textContent = q?.studente_compilatore || "";
        tr.appendChild(tdStudente);
        // Data Ultima Modifica
        const tdData = document.createElement("td");
        const dateStr = q?.datatime_ultima_modifica || "";
        if (dateStr) {
          let dateObj = new Date(dateStr);
          const options = {
            timeZone: "Europe/Rome",
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
            hour: "2-digit",
            minute: "2-digit"
          };
          if (isNaN(dateObj.getTime())) {
            dateObj = parseItalianDateTime(dateStr);
          }
          tdData.textContent = (dateObj && !isNaN(dateObj.getTime())) ? dateObj.toLocaleString("it-IT", options) : "Data non valida";
        }
        tr.appendChild(tdData);
        // Completamento
        const tdCompletion = document.createElement("td");
        let completionPercent = 0;
        if (strutturaData && q?.informazioni_compilazione) {
          completionPercent = calculateCompletionSerious(q.informazioni_compilazione, strutturaData.informazioni_compilazione);
        }
        const classification = classifyCompletion(completionPercent);
        tdCompletion.textContent = completionPercent + '% (' + classification + ')';
        tr.appendChild(tdCompletion);
        // Azioni
        const tdAzioni = document.createElement("td");
        const btnVisualizza = document.createElement("button");
        btnVisualizza.classList.add("icon-button");
        btnVisualizza.innerHTML = "&#128065;";
        btnVisualizza.title = "Visualizza questionario";
        btnVisualizza.onclick = () => {
          if (q) {
            window.location.href = "page.html?mode=view&id=" + encodeURIComponent(q.questionario_id);
          }
        };
        tdAzioni.appendChild(btnVisualizza);
        const btnModifica = document.createElement("button");
        btnModifica.classList.add("icon-button");
        btnModifica.innerHTML = "&#9998;";
        btnModifica.title = "Modifica questionario";
        if (isLockedByOther) {
          btnModifica.disabled = true;
          btnModifica.style.opacity = 0.5;
          btnModifica.onclick = () => { showLockModal(); };
        } else {
          btnModifica.onclick = () => {
            if (q) {
              window.location.href = "page.html?mode=edit&id=" + encodeURIComponent(q.questionario_id);
            }
          };
        }
        tdAzioni.appendChild(btnModifica);
        tr.appendChild(tdAzioni);
        tbody.appendChild(tr);
      });
    }

    function getStatusIcon(status, commenti) {
      let iconHtml = "";
      const statusLower = String(status).toLowerCase();
      if (statusLower === "inviato") {
        iconHtml = '<span class="status-icon" style="background-color: #3498db;" title="Inviato">✉️</span>';
      } else if (statusLower === "respinto") {
        iconHtml = `<span class="status-icon" style="background-color: red; cursor: pointer;" title="Respinto" onclick="showCommentiRevisore('${(commenti || "").replace(/'/g, "\\'")}')">❌</span>`;
      } else if (statusLower === "da verificare") {
        iconHtml = '<span class="status-icon" style="background-color: green;" title="Da Verificare">🧐</span>';
      } else if (statusLower === "accettato") {
        iconHtml = '<span class="status-icon" style="background-color: green;" title="Accettato">✅</span>';
      } else {
        iconHtml = '<span class="status-icon" style="background-color: gray;" title="Sconosciuto">?</span>';
      }
      return iconHtml;
    }

    function applyColumnFilters() {
      const filters = document.querySelectorAll(".column-filter");
      const tbody = document.querySelector("#questionariTable tbody");
      const rows = tbody.querySelectorAll("tr");
      rows.forEach(row => {
        let showRow = true;
        filters.forEach(filter => {
          const colIndex = filter.getAttribute("data-col-index");
          const cellText = row.cells[colIndex].textContent.toLowerCase();
          const filterValue = filter.value.toLowerCase();
          if (filterValue && !cellText.includes(filterValue)) {
            showRow = false;
          }
        });
        row.style.display = showRow ? "" : "none";
      });
    }

    document.querySelectorAll(".column-filter").forEach(input => {
      input.addEventListener("input", applyColumnFilters);
    });

    // Funzione per chiudere il modal dei commenti
    function closeCommentiModal() {
      document.getElementById('commentiModal').style.display = 'none';
    }

    // (Ulteriori funzioni, ad es. gestione dei lock, potrebbero essere aggiunte qui)
  </script>
</body>
</html>